name: Advanced Plugin Translations
on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'  # Ogni domenica a mezzanotte
  workflow_dispatch:

jobs:
  translation-workflow:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        plugin_type: [system, extensions, systemplugins ]
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up environment
      run: |
        # Installa tool necessari per Enigma2
        sudo apt-get update
        sudo apt-get install -y \
          gettext \
          msgfmt \
          msgmerge \
          msguniq \
          python3-lxml \
          python3-xmltodict
          
    - name: Discover Enigma2 plugins
      id: discover
      run: |
        # Cerca plugin in tutte le directory standard Enigma2
        PLUGIN_PATHS=(
          "/usr/lib/enigma2/python/Plugins/Extensions"
          "/usr/lib/enigma2/python/Plugins/SystemPlugins"
        )
        
        for path in "${PLUGIN_PATHS[@]}"; do
          if [ -d "$path" ]; then
            echo "üîç Scanning: $path"
            find "$path" -maxdepth 2 -name "*.py" -type f | head -20
          fi
        done
        
    - name: Process translations
      env:
        PLUGIN_DIRS: ${{ steps.discover.outputs.plugin_dirs }}
      run: |
        # Script Python per processare tutte le traduzioni
        python3 << 'EOF'
        import os
        import subprocess
        import json
        
        # Percorsi standard Enigma2
        enigma2_paths = [
            "/usr/lib/enigma2/python",
            "/usr/share/enigma2",
        ]
        
        print("üîÑ Starting translation processing...")
        
        # Trova tutti i file .po nel repository
        for root, dirs, files in os.walk("."):
            for file in files:
                if file.endswith(".po"):
                    po_file = os.path.join(root, file)
                    lang = file.split(".")[0]
                    
                    print(f"üìÑ Processing: {po_file}")
                    
                    # Usa msguniq per pulire i duplicati
                    subprocess.run([
                        "msguniq", "--no-wrap", 
                        po_file, "-o", po_file
                    ], check=False)
                    
        print("‚úÖ Translation processing complete")
        EOF
        
    - name: Generate translation report
      run: |
        # Genera un report delle traduzioni
        python3 << 'EOF'
        import os
        import json
        
        translation_stats = {
            "total_po_files": 0,
            "total_strings": 0,
            "languages": {},
            "plugins": {}
        }
        
        for root, dirs, files in os.walk("."):
            for file in files:
                if file.endswith(".po"):
                    po_path = os.path.join(root, file)
                    lang = file.split(".")[0]
                    plugin_name = root.split("/")[-3] if len(root.split("/")) >= 3 else "unknown"
                    
                    translation_stats["total_po_files"] += 1
                    
                    # Conta le lingue
                    if lang not in translation_stats["languages"]:
                        translation_stats["languages"][lang] = 0
                    translation_stats["languages"][lang] += 1
                    
                    # Conta per plugin
                    if plugin_name not in translation_stats["plugins"]:
                        translation_stats["plugins"][plugin_name] = []
                    translation_stats["plugins"][plugin_name].append(lang)
        
        # Salva report
        with open("translation_report.json", "w") as f:
            json.dump(translation_stats, f, indent=2)
            
        print("üìä Translation Report:")
        print(json.dumps(translation_stats, indent=2))
        EOF
        
    - name: Upload translation artifacts
      uses: actions/upload-artifact@v3
      with:
        name: translation-files
        path: |
          **/*.po
          **/*.mo
          **/*.pot
          translation_report.json
          
    - name: Send notification
      if: always()
      run: |
        echo "üìß Sending notification..."
        # Puoi integrare con email, Slack, Discord, etc.
        
    - name: Create summary
      if: always()
      run: |
        echo "### üìã Translation Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ **Workflow completed successfully**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Processed files:**" >> $GITHUB_STEP_SUMMARY
        echo "- .po files: $(find . -name "*.po" | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- .mo files: $(find . -name "*.mo" | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- Languages: $(ls locale/ 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
  
