name: Intelligent Translation Updater
on:
  push:
    paths:
      - '**/*.py'
      - '**/*.xml'
      - '**/locale/**'
      - '**/*.po'
      - '**/*.pot'
  workflow_dispatch:

jobs:
  smart-translation-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup
      run: |
        sudo apt-get update
        sudo apt-get install -y gettext
        pip install lxml beautifulsoup4
        
    - name: Run intelligent locale scanner
      id: scanner
      run: |
        python3 find_locale_dirs.py
        echo "SCAN_COMPLETE=true" >> $GITHUB_OUTPUT
        
    - name: Process translations based on scan
      if: steps.scanner.outputs.SCAN_COMPLETE == 'true'
      run: |
        # Leggi il report dello scanner
        if [ -f "locale_scan_report.json" ]; then
          echo "ðŸ“‹ Processing plugins from scan report..."
          
          # Usa jq per processare il JSON
          plugins=$(python3 -c "
          import json
          data = json.load(open('locale_scan_report.json'))
          for plugin in data:
              print(f'{plugin[\"plugin_dir\"]}::{plugin[\"plugin_name\"]}')
          ")
          
          for entry in $plugins; do
            IFS='::' read -r plugin_dir plugin_name <<< "$entry"
            
            echo ""
            echo "ðŸ”„ Processing: $plugin_name"
            echo "ðŸ“ Directory: $plugin_dir"
            
            if [ -f "$plugin_dir/update_translations.py" ]; then
              echo "âœ… Using existing update script"
              cd "$plugin_dir"
              python3 update_translations.py || echo "âš ï¸ Script had issues"
              cd - > /dev/null
            else
              echo "â„¹ï¸ No update script, using generic processor"
              # Usa un processore generico
              process_generic_translations "$plugin_dir"
            fi
          done
        fi
        
    - name: Generic translation processor function
      run: |
        process_generic_translations() {
          local plugin_dir="$1"
          
          echo "ðŸ”§ Running generic translation processor..."
          
          # Cerca file .po
          po_files=$(find "$plugin_dir" -name "*.po" -type f)
          
          if [ -z "$po_files" ]; then
            echo "âš ï¸ No .po files found"
            return
          fi
          
          echo "ðŸ“„ Found $(echo "$po_files" | wc -l) .po files"
          
          # Per ogni file .po
          while IFS= read -r po_file; do
            echo "  â€¢ Processing: $(basename "$po_file")"
            
            # Pulisci il file
            msguniq --no-wrap "$po_file" -o "$po_file.clean"
            mv "$po_file.clean" "$po_file"
            
            # Compila .mo se necessario
            mo_file="${po_file%.po}.mo"
            msgfmt "$po_file" -o "$mo_file" 2>/dev/null && \
              echo "    âœ“ Compiled: $(basename "$mo_file")"
            
          done <<< "$po_files"
        }
        
        export -f process_generic_translations
